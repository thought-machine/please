subinclude("//build_defs:test")

target(
    name = "runtime_deps_from_deps",
    runtime_deps_from_deps = True,
    deps = [":dep_with_exported_dep"],
)

target(
    name = "dep_with_exported_dep",
    exported_deps = [":exported_dep"],
    deps = [":dep"],
)

target(
    name = "exported_dep",
    runtime_deps = [":exported_dep_runtime_dep"],
)

target(
    name = "dep",
    runtime_deps = [":dep_runtime_dep"],
)

runtime_dep("exported_dep_runtime_dep")
runtime_dep("dep_runtime_dep")

gentest(
    name = "runtime_deps_from_exported_deps_test_case",
    outs = ["runtime_deps_from_exported_deps_test_case"],
    cmd = [
        not_exists("dep_runtime_dep"),
        not_exists("exported_dep_runtime_dep"),
        "touch $OUTS",
    ],
    data = [":runtime_deps_from_deps"],
    no_test_output = True,
    test_cmd = [
        # This still shouldn't exist - it's a build-time dependency of a build-time dependency, not a run-time
        # dependency of a build-time dependency.
        not_exists("dep_runtime_dep"),
        # This one should exist - it's a run-time dependency of an (exported) build-time dependency.
        exists("exported_dep_runtime_dep"),
    ],
)
