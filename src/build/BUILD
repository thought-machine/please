go_library(
    name = 'build',
    srcs = glob(
        ['*.go'],
        excludes = ['*_test.go'],
    ),
    visibility = ['PUBLIC'],
    deps = [
        '//src/cache',
        '//src/core',
        '//src/metrics',
        '//src/parse',
        '//third_party/go:logging',
    ],
)

go_test(
    name = 'command_replacements_test',
    srcs = ['command_replacements_test.go'],
    deps = [
        ':build',
        '//third_party/go:testify',
    ],
)

go_test(
    name = 'incrementality_test',
    srcs = ['incrementality_test.go'],
    deps = [
        ':build',
    ],
)

go_test(
    name = 'build_step_test',
    srcs = ['build_step_test.go'],
    data = ['test_data'],
    mocks = {
        'parse': '//src/mock:parse',
    },
    deps = [
        ':build',
        '//src/core',
        '//src/output',
        '//third_party/go:testify',
    ],
)

go_test(
    name = 'build_step_stress_test',
    srcs = ['build_step_stress_test.go'],
    mocks = {
        'parse': '//src/mock:parse',
    },
    deps = [
        ':build',
        '//src/core',
        '//src/output',
        '//third_party/go:testify',
    ],
)
